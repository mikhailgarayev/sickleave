<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absence Request</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); }
    .scrollbox { max-height: 240px; overflow: auto; }
  </style>
</head>
<body class="bg-blue-400 font-sans antialiased"
      style="background-image:url('background.png');background-size:cover;background-position:right 30%;background-repeat:no-repeat;">

  <div class="flex items-center justify-center min-h-screen p-6">
    <div class="card rounded-xl shadow-xl overflow-hidden max-w-5xl w-full grid grid-cols-1 md:grid-cols-2">
      <!-- Left: instructions -->
      <div class="p-10 bg-white/80 flex flex-col justify-center">
        <h2 class="text-4xl font-extrabold text-gray-800 mb-6">Before You Submit</h2>
        <ul class="space-y-4 text-gray-700 text-lg list-none">
          <li>✅ Get approval from your Team Lead.</li>
          <li>✅ Complete all fields accurately.</li>
          <li>ℹ️ Personal comments visible only to your Team Lead.</li>
        </ul>
        <div id="sheetStatus" class="mt-6 text-sm text-gray-500">Loading shifts…</div>
      </div>

      <!-- Right: form -->
      <div class="p-10">
        <form id="absenceForm" class="w-full space-y-5">
          <!-- Email with datalist suggestions -->
          <div>
            <label for="employee" class="block text-gray-700 font-medium mb-1">Your Email</label>
            <input list="emails" type="email" id="employee" name="employee" required
                   class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 bg-white"
                   placeholder="you@company.com">
            <datalist id="emails"></datalist>
          </div>

          <!-- Shifts selector -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">Select Shifts to Skip</label>
            <div id="shiftsBox" class="scrollbox border border-gray-200 rounded-lg p-3 bg-white">
              <div class="text-gray-500 text-sm">Start typing your email to see shifts.</div>
            </div>
          </div>

          <!-- Reason -->
          <div>
            <label for="reason" class="block text-gray-700 font-medium mb-1">Reason</label>
            <select id="reason" name="reason" required
                    class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 bg-white">
              <option value="">Select reason</option>
              <option value="University">University</option>
              <option value="Feeling bad">Feeling bad</option>
              <option value="Personal reason">Personal reason</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Comment for Personal/Other -->
          <div id="personalReasonContainer" class="hidden">
            <label for="personalReason" class="block text-gray-700 font-medium mb-1">Comment</label>
            <textarea id="personalReason" name="personal_reason" rows="3"
                      class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 bg-white"
                      placeholder="Please specify..."></textarea>
          </div>

          <!-- Team Lead -->
          <div>
            <label for="teamLead" class="block text-gray-700 font-medium mb-1">Team Lead</label>
            <select id="teamLead" name="teamlead" required
                    class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 bg-white">
              <option value="mikhail.garayev@wolt.com">Mikhail Garayev</option>
              <option value="murad.ismayilov@wolt.com">Murad Ismayilov</option>
              <option value="pavlos.vasilakis@wolt.com">Pavlos Vasilakis</option>
            </select>
          </div>

          <input type="hidden" id="submittedTime" name="submittedtime">

          <button type="submit"
                  class="w-full py-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-shadow shadow-md">
            Submit Request
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SHEET_ID   = '12gcER4PN-gE3sAOz5pj_ihT-cdmqA6XhSn2wCb-6ykk';
    const SHEET_NAME = 'Shifts';
    const GVIZ_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1&tqx=out:json`;
    const SLACK_WORKFLOW_URL = 'https://hooks.slack.com/triggers/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';

    // ====== Helpers for GVIZ dates ======
    function parseGvizDate(val) {
      // "Date(2025,7,12,9,0,0)" -> Date
      if (typeof val !== 'string') return null;
      const m = val.match(/^Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)$/);
      if (!m) return null;
      const [_, y, mo, d, h, mi, s] = m.map(Number);
      return new Date(y, mo, d, h, mi, s);
    }
    function formatDDMMYYYY_HHMM(dt) {
      const pad = n => n.toString().padStart(2,'0');
      return `${pad(dt.getDate())}.${pad(dt.getMonth()+1)}.${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    }
    function fmtMaybeGviz(val) {
      const d = parseGvizDate(val);
      return d ? formatDDMMYYYY_HHMM(d) : (val || '');
    }

    // ====== GVIZ parsing ======
    function parseGviz(text) {
      const s = text.indexOf('{'), e = text.lastIndexOf('}');
      if (s === -1 || e === -1) throw new Error('Bad GVIZ payload');
      return JSON.parse(text.slice(s, e + 1));
    }
    function tableToRows(tbl) {
      const cols = tbl.cols.length;
      return (tbl.rows || []).map(r =>
        Array.from({length: cols}, (_, i) => (r.c[i]?.v ?? '').toString().trim())
      );
    }

    // ====== Data cache ======
    let byEmail = new Map(); // email -> rows

    // ====== Renderers ======
    function renderEmails(uniqueEmails) {
      const dl = document.getElementById('emails');
      dl.innerHTML = '';
      uniqueEmails.forEach(e => {
        if (!e) return;
        const opt = document.createElement('option');
        opt.value = e;
        dl.appendChild(opt);
      });
    }

    function renderShifts(email) {
      const box = document.getElementById('shiftsBox');
      box.innerHTML = '';
      const rows = byEmail.get(email) || [];
      if (!rows.length) {
        box.innerHTML = '<div class="text-gray-500 text-sm">No shifts found for this email.</div>';
        return;
      }
      const list = document.createElement('div');
      list.className = 'space-y-3';

      rows.forEach((r, idx) => {
        // columns: B=email(1), E=type(4), F=start(5), G=end(6)
        const type   = r[4] || '-';
        const startR = r[5] || '';
        const endR   = r[6] || '';
        const startF = fmtMaybeGviz(startR);
        const endF   = fmtMaybeGviz(endR);

        const payloadForItem = encodeURIComponent(JSON.stringify({
          type, start: startF, end: endF, start_raw: startR, end_raw: endR
        }));

        const item = document.createElement('label');
        item.className = 'flex items-start gap-3 p-3 border border-gray-200 rounded-lg bg-white hover:bg-gray-50 cursor-pointer shadow-sm';

        item.innerHTML = `
          <input type="checkbox" class="mt-1 h-4 w-4 text-blue-600 rounded" value="${payloadForItem}">
          <div>
            <div class="font-medium text-gray-800">${type}</div>
            <div class="text-sm text-gray-600">${startF} — ${endF}</div>
          </div>
        `;
        list.appendChild(item);
      });

      box.appendChild(list);
    }

    // ====== Load Google Sheet ======
    (async function loadSheet(){
      const status = document.getElementById('sheetStatus');
      try {
        const res = await fetch(GVIZ_URL, {cache:'no-store'});
        const txt = await res.text();
        const json = parseGviz(txt);
        const rows = tableToRows(json.table);

        byEmail = new Map();
        rows.forEach(r => {
          const email = (r[1] || '').toLowerCase(); // column B
          if (!email) return;
          if (!byEmail.has(email)) byEmail.set(email, []);
          byEmail.get(email).push(r);
        });

        renderEmails(Array.from(byEmail.keys()).sort());
        status.textContent = 'Shifts loaded. Start typing your email to see matches.';
      } catch (e) {
        console.error(e);
        status.textContent = 'Failed to load shifts. Make sure the sheet is shared: “Anyone with the link – Viewer”.';
      }
    })();

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('absenceForm');
    const reason = document.getElementById('reason');
    const personalContainer = document.getElementById('personalReasonContainer');
    const personalField = document.getElementById('personalReason');
    const emailInput = document.getElementById('employee');

    reason.addEventListener('change', () => {
      if (['Personal reason', 'Other'].includes(reason.value)) {
        personalContainer.classList.remove('hidden'); personalField.required = true;
      } else {
        personalContainer.classList.add('hidden'); personalField.required = false;
      }
    });

    function onEmailChange(){
      const email = emailInput.value.trim().toLowerCase();
      renderShifts(email);
    }
    emailInput.addEventListener('change', onEmailChange);
    emailInput.addEventListener('input', onEmailChange);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const selected = Array
        .from(document.querySelectorAll('#shiftsBox input[type="checkbox"]:checked'))
        .map(cb => JSON.parse(decodeURIComponent(cb.value)));

      if (!selected.length) {
        alert('Please select at least one shift.');
        return;
      }

      // Submitted time as DD.MM.YY HH:MM:SS
      const d = new Date();
      const pad = n => n.toString().padStart(2,'0');
      const submitted = `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear().toString().slice(-2)} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.getElementById('submittedTime').value = submitted;

      const payload = {
        employee: emailInput.value.trim(),
        reason: reason.value,
        teamlead: document.getElementById('teamLead').value,
        personal_reason: personalContainer.classList.contains('hidden') ? '' : personalField.value,
        selected_shifts: selected,              // [{type, start, end, start_raw, end_raw}, ...]
        selected_shifts_count: selected.length,
        submittedtime: submitted
      };

      try {
        const res = await fetch(SLACK_WORKFLOW_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
          // ВАЖНО: без 'mode:no-cors', иначе Slack не увидит application/json и вернёт 400.
        });

        if (!res.ok) {
          // Прочитать текст ответа, если CORS позволит (иначе будет ошибка — это ок)
          let text = '';
          try { text = await res.text(); } catch {}
          throw new Error(`Slack responded ${res.status}${text ? `: ${text}` : ''}`);
        }

        alert('Your absence request has been submitted.');
        form.reset();
        document.getElementById('shiftsBox').innerHTML =
          '<div class="text-gray-500 text-sm">Start typing your email to see shifts.</div>';
      } catch (err) {
        console.error(err);
        // Частые причины: AdBlock/Privacy-блокер, корпоративная политика CORS, неверный URL триггера
        alert('Submit failed. Please: 1) disable AdBlock for this page, 2) verify the Workflow *Webhook trigger* URL, 3) try again.');
      }
    });
  });
  </script>
</body>
</html>
